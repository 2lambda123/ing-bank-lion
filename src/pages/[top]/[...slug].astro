---
import { glob } from 'glob'
import * as fs from 'fs';
import * as process from 'process';
import MainLayout from '../../layouts/MainLayout.astro';
import { UIPortalInpageNav } from "../../components/ui-portal-inpage-nav.js";
import * as path from 'path';
import { fundamentalsEntries, allPages } from '../../content';
import { blogEntries } from '../../content';
import { guideEntries } from '../../content';
import { maxDepthForNonComponentsNavigation } from '../../../config.mjs';

let pages = [];
const inPageNavData = [];
let mdjsStoriesJsPath = ''


export async function getStaticPaths() {
  const fundamentalsArr = fundamentalsEntries.map(entry => ({
    params: { 
      top: 'fundamentals',
      slug: entry.slug.split('fundamentals/')[1] 
    },
    props: { entry },
  }));

  const blogArr = blogEntries.map(entry => ({
    params: { 
      top: 'blog',
      slug: entry.slug.split('blog/')[1] 
    },
    props: { entry },
  }));

  const guideArr = guideEntries .map(entry => ({
    params: { 
      top: 'guides',
      slug: entry.slug.split('guides/')[1] 
    },
    props: { entry },
  }));

  const dirArr = allPages
    .filter(entry => {
      const separator = '/';
      const dirPath = path.dirname(entry.slug);
      const dirParts = dirPath.split(separator);

      return dirParts.length >= maxDepthForNonComponentsNavigation && dirParts[0] !== 'components';      
    })
    .map(entry => {
      const separator = '/';
      const dirPath = path.dirname(entry.slug);
      const dirParts = dirPath.split(separator);
      dirParts.splice(maxDepthForNonComponentsNavigation);
      const result = {
        params: { 
          top: dirParts.shift(),
          slug: dirParts.join(separator) 
        },
      };
      return result;
    });

    const uniqueDirArr = [];
    dirArr.forEach(route => {
      if (!uniqueDirArr.find(uniqueRoute => uniqueRoute.params.top === route.params.top && uniqueRoute.params.slug === route.params.slug)) {
        uniqueDirArr.push(route);
      }
    });

  return [...fundamentalsArr, ...blogArr, ...guideArr, ...dirArr];
}

const { entry } = Astro.props;

const renderDir = async (directoryPath) => {
  const entries = getEntriesByDir(directoryPath);
  return await concatenateEntries(entries);
};

const convertHeadingsToInPageNavData = (headings, componentSlug) => {
  return headings.map(header => ({
      name: header.text,
      url: `/${path.dirname(componentSlug)}#${header.slug}`
    }));
};

const parseEntries = async (entries) => {
  const contents = [];
  for (const componentEntry of entries) {
    const { Content, headings, remarkPluginFrontmatter } = await componentEntry.render();
    const order = remarkPluginFrontmatter.order;
    const slug = componentEntry.slug;
    const content = {Content, headings, order, slug};
    contents.push(content);
  }
  return contents;
};

const updateHeadings = (contentItems) => {
  for (const contentItem of contentItems) {
    const headersH2 = contentItem.headings.filter(header => header.depth === 2);
    const entryInPageNavData = convertHeadingsToInPageNavData(headersH2, contentItem.slug)[0];
    const headersH3 = contentItem.headings.filter(header => header.depth === 3);
    entryInPageNavData.children = convertHeadingsToInPageNavData(headersH3, contentItem.slug);
    inPageNavData.push(entryInPageNavData);
  }
};

async function concatenateEntries(entries) {
  const contents = await parseEntries(entries);
  //contents.sort((a, b) => a.order < b.order ? -1 : 1);
  updateHeadings(contents);
  return contents;
}

const getEntriesByDir = (dirname) => {
  return allPages.filter(childEntry => childEntry.slug.startsWith(dirname));
};

const getMdjsStories = (fullDirPath) => {
  return new Promise((resolve, reject) => {    
    glob(fullDirPath + '/**/__mdjs-stories--*.js', {}, (err, files)=>{
      const relativePaths = files.map(file => {
        return path.relative(fullDirPath, file);
      });
      resolve(relativePaths);
    })
  });  
};

if (entry) {
  pages = await concatenateEntries([entry]);
} else {
  const dirPath = path.join(Astro.params.top, Astro.params.slug);
  pages = await renderDir(dirPath);
  const fullDirPath = path.join(process.cwd(), 'public/docs', dirPath);
  const files = await getMdjsStories(fullDirPath);
  let imports = '';
  files.forEach(file => {
    imports += `import('./${file}');\n`
  });
  mdjsStoriesJsPath = path.join(fullDirPath, '__mdjs-stories.js');
  fs.writeFileSync(mdjsStoriesJsPath, imports, 'utf8');
  console.log('imports: ', imports);
}

const getPathMdjsStroriesFile = () => {
  if (entry) {
    const mdjsStroriesFileDirectory = path.dirname(entry.slug);
    return `/docs/${mdjsStroriesFileDirectory}/__mdjs-stories--${path.basename(entry.slug)}.js`;
  } 
  return '/docs' + mdjsStoriesJsPath.split('/docs')[1];
}

---

<MainLayout title={entry?.slug}>
  <UIPortalInpageNav nav-data={JSON.stringify(inPageNavData)} />
  {
    pages.map((page) => (
        <page.Content />        
    ))
  }
  <script is:inline src="/docs/_assets/scoped-custom-element-registry.min.js"></script>
  <script type="module" src={getPathMdjsStroriesFile()} mdjs-setup></script>
</MainLayout>
