---
import * as path from 'path';
import { componentInfoEntries, getComponentEntries } from '../../content';
import MainLayout from "../../layouts/MainLayout.astro";
import ComponentLayout from "../../layouts/partials/ComponentPartial.astro";
import { UIPortalInpageNav } from "../../components/ui-portal-inpage-nav.js";

export async function getStaticPaths() {
  return componentInfoEntries.map((entry) => ({    
    params: { 
      component: entry.data.component     
    },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const componentEntries = getComponentEntries(entry.data.component);
const inPageNavData = [];

const convertHeadingsToInPageNavData = (headings, componentSlug) => {
  return headings.map(header => ({
      name: header.text,
      url: `/${path.dirname(componentSlug)}#${header.slug}`
    }));
};

const parseEntries = async (entries) => {
  const contents = [];
  for (const componentEntry of entries) {
    const { Content, headings, remarkPluginFrontmatter } = await componentEntry.render();
    const order = remarkPluginFrontmatter.order;
    const slug = componentEntry.slug;
    contents.push({Content, headings, order, slug});    
  }
  return contents;
};

const updateHeadings = (contentItems) => {
  for (const contentItem of contentItems) {
    const headersH2 = contentItem.headings.filter(header => header.depth === 2);
    if (headersH2.length === 0) {
      continue;
    }
    const entryInPageNavData = convertHeadingsToInPageNavData(headersH2, contentItem.slug)[0];
    const headersH3 = contentItem.headings.filter(header => header.depth === 3);
    if (headersH3.length !== 0) {
      entryInPageNavData.children = convertHeadingsToInPageNavData(headersH3, contentItem.slug);
    }    
    inPageNavData.push(entryInPageNavData);
  }
};

async function concatenateEntries(entries) {
  const contents = await parseEntries(entries);
  contents.sort((a, b) => a.order < b.order ? -1 : 1);
  updateHeadings(contents);
  return contents;
}

const pages = await concatenateEntries(componentEntries);


const getPathMdjsStroriesFile = (entry) => {
  const mdjsStroriesFileDirectory = path.dirname(entry.slug);
  return `/docs/${mdjsStroriesFileDirectory}/__mdjs-stories.js`;
} 
---

<MainLayout title={entry.slug}>
  <ComponentLayout frontmatter={entry.data}>
    <UIPortalInpageNav nav-data={JSON.stringify(inPageNavData)} />
    {
      pages.map((page) => (
          <page.Content />        
      ))
    }
    <script is:inline src="/docs/_assets/scoped-custom-element-registry.min.js"></script>
    <script is:inline type="module" src={getPathMdjsStroriesFile(componentEntries[0])} mdjs-setup></script>
  </ComponentLayout>
</MainLayout>
