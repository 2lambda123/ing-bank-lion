---
import { componentInfoEntries, getComponentEntries } from '../../content';
import MainLayout from "../../layouts/MainLayout.astro";
import ComponentLayout from "../../layouts/partials/ComponentPartial.astro";
import { UIPortalInpageNav } from "../../components/ui-portal-inpage-nav.js";

export async function getStaticPaths() {
  return componentInfoEntries.map((entry) => ({    
    params: { 
      component: entry.data.component     
    },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const componentEntries = getComponentEntries(entry.data.component);
const inPageNavData = [];
const contents = [];

const convertHeadingsToInPageNavData = (headings, componentEntry) => {
  return headings.map(header => ({
      name: header.text,
      url: `/${componentEntry.slug}#${header.slug}`
    }));
};

const parseEntries = async () => {
  for (const componentEntry of componentEntries) {
    const { Content, headings } = await componentEntry.render();
    contents.push({Content});
    const headersH1 = headings.filter(header => header.depth === 1);
    const entryInPageNavData = convertHeadingsToInPageNavData(headersH1, componentEntry)[0];
    const headersH2 = headings.filter(header => header.depth === 2);
    entryInPageNavData.children = convertHeadingsToInPageNavData(headersH2, componentEntry);
    inPageNavData.push(entryInPageNavData);
  }
};

await parseEntries();

const getPathForComponentMdjsStrories = () => {
  // components/component_name/overview
  const componentEntrySlugArr = componentEntries[0].slug.split('/');
  // components/component_name
  componentEntrySlugArr.pop();
  const componentDirectory = componentEntrySlugArr.join('/');
  return `/public/mdjs-stories/docs/${componentDirectory}/__mdjs-stories.js`;
} 
---

<MainLayout title={entry.slug}>
  <ComponentLayout frontmatter={entry.data}>
    <UIPortalInpageNav nav-data={JSON.stringify(inPageNavData)} />
    {
      contents.map((content) => (        
          <content.Content />        
      ))
    }
    <script type="module" src={getPathForComponentMdjsStrories()} mdjs-setup></script>
  </ComponentLayout>
</MainLayout>
  